# FAQ
### Q: Как подключиться к БД?
A: Нужно запустить контейнер с БД и указать правильные настройки подключения.
1. Установить Docker Desktop ([mac](https://docs.docker.com/desktop/install/mac-install/), [windows](https://docs.docker.com/desktop/install/windows-install/), [linux](https://docs.docker.com/desktop/install/linux-install/))
2. В терминале в корневой папке проекта выполнить комманду=
```
> docker compose up -d
```
3. В IDE указать следующие параметры подключения к БД:
   - host/server: **localhost**
   - port: **15432**
   - user: **postgres**
   - password: **123456**
   - database: **price-calculator**

### Q: Не выполняются интеграционные тесты, что делать?
A: Убедитесь, что запущен контейнер с БД и вы можете подключить к БД из любого IDE.

# Домашнее задание

## Описание сервиса
Сервис выполняет расчет стоимости доставки грузов на расстояние 1км. Расчет осуществляется на основе массогабаритных показателей.
Метод **POST /v1/delivery-prices/calculate** принимает запрос от пользователя (UserId), содержащий массив товаров, описанных габаритами и массой:
- длина (length), м
- ширина (width), м
- высота (height), м
- масса (weight), кг

По данным параметрам производится вычисление стоимости доставки на основе габаритов и на основе веса, итоговое значение - максимальная стоимость из двух.
Товары, участвующие в расчете, и сам расчет сохраняется в БД с привязкой к пользователю.

Метод **POST /v1/delivery-prices/get-history** позволяет получить расчеты, которые производил пользователь (UserId). Метод позволяет получать расчеты диапазоном, где Take - сколько расчетов необходимо вернуть, Skip - сколько расчетов необходимо пропустить. Расчеты отсортированы по убыванию - от самого последнего к самому раннему.

## STORY-099: Я как пользователь могу очистить свою историю расчетов
### Описание
Пользователь может частично или полностью очистить свою историю расчетов. Товары, связанные с удаляемыми расчетами, должны так же удаляться.

### Что нужно сделать
Пользователь может указать идентификаторы расчетов, которые хочет удалить. Если не указал ничего - чистим всю историю расчетов этого пользователя.
В транзакции нужно удалить одним запросом расчеты, а затем, так же одним запросом, удалить и товары, участвующие в них.
Добавить HP-интеграционные тесты на новые методы репозиториев.
Добавить HP-юнит тесты на новые методы сервиса
Добавить юнит тесты на команду, проверяющие как HP, так и проверки на принадлежность и существование расчетов.
```
POST /v1/delivery-prices/clear-history
<= { 
  user_id: 0, 
  calculation_ids: [ 0,, ... ] 
}
=> 200 {}
=> 403 OneOrManyCalculationsBelongsToAnotherUserException { wrong_calculation_ids: [0, ...]}
=> 400 OneOrManyCalculationsNotFoundException
```
- 403 - если среди указанных расчетов есть не принадлежащие текущему пользователю
- 400 - если среди указанных расчетов есть вовсе отсутствующие в БД

# Задание за алмаз
## STORY-100: Я как пользователь могу получить из истории расчетов только конкретные расчеты
### Описание
Нужен дополнительный фильтр по массиву ИД расчетов (calculation_ids), который МОЖЕТ использоваться совместно с другими (уже существующими). Если переданных ИД расчетов нет у текущего пользователя или они вовсе отсутствуют, то возвращать пустой массив.

### Что нужно сделать

Нужно написать новую _(V2)_ версию метода получения истории вычислений. Новый метод должен содержать дополнительный аргумент _(calculation_ids)_ представляющий собой массив Id вычислений. Фильтр по `CalculationIds` применяется после применения `Skip` и `Take` операций. При пустом массиве `CalculationIds` этот фильтр не применяется.

Если в выборке присутствуют вычисления с UserId не совпадающим с переданным в качестве аргумента нужно выбосить исключение с кодом ошибки `403 Forbidden` и вернуть пустой массив.

Если в выборке отсутствуют вычисления с Id из аргумента(calculation_ids), то нужно выбросить исключение  с кодом ошибки `400 Bad Request` и вернуть пустой массив.

```
POST /v2/delivery-prices/get-history
<= { 
  user_id: 0, 
  take: 0,
  skip: 0,
  calculation_ids: [ 0,, ... ] 
}
=> 200 {}
=> 403 OneOrManyCalculationsBelongsToAnotherUserException { wrong_calculation_ids: [0, ...]}
=> 400 OneOrManyCalculationsNotFoundException
```

Необходимо написать HP-интеграционный тест на новый метод репозитория. Добавить юнит тесты на _запрос_, проверяющие как HP, так и проверки на принадлежность и существование расчетов.
